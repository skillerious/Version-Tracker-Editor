<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <title>Version Tracker — Loading</title>
    <link rel="stylesheet" href="./splash.css" />
  </head>
  <body>
    <div
      class="splash-window"
      role="application"
      aria-label="Version Tracker loading screen"
    >
      <!-- Titlebar (now flush to top) -->
      <header class="splash-titlebar">
        <div class="title-left">
          <div class="title-icon" aria-hidden="true">
            <img src="./assets/logo.png" alt="" />
          </div>
          <div class="title-text">
            <span class="app-name">Version Tracker Editor</span>
            <span class="app-status" data-status-text>Starting…</span>
          </div>
        </div>
        <div class="title-right">
          <span class="title-pill" data-phase-pill>Loading</span>
        </div>
      </header>

      <!-- Body -->
      <main class="splash-body">
        <header class="primary-header">
          <h1>Preparing your workspace</h1>
          <p>Restoring layout, loading manifests, and checking for remote changes.</p>
          <span class="env-line" data-env-line>Environment: Desktop • GitHub enabled</span>
        </header>

        <!-- 2-column layout -->
        <div class="splash-grid">
          <section class="card card-progress" aria-label="Startup tasks">
            <div class="card-header">
              <div>
                <h2>Startup tasks</h2>
                <p>This will only take a moment.</p>
              </div>
              <span class="progress-value" data-progress-label>0%</span>
            </div>
            <div class="progress-track" aria-hidden="true">
              <div class="progress-fill"></div>
            </div>

            <!-- vertical pills -->
            <div class="meta-column">
              <div class="meta-pill active">
                <span class="meta-title">Secure token storage</span>
                <span class="meta-sub">Encrypted locally</span>
              </div>
              <div class="meta-pill">
                <span class="meta-title">Manifest insights</span>
                <span class="meta-sub">Schema aware</span>
              </div>
              <div class="meta-pill">
                <span class="meta-title">GitHub powered</span>
                <span class="meta-sub">Remote sync</span>
              </div>
            </div>

            <div class="system-row">
              <div class="system-chip">
                <span class="system-dot online"></span>
                Core services online
              </div>
              <div class="system-chip muted" data-footer-left>Loading environment...</div>
            </div>
          </section>
        </div>
      </main>

      <!-- Footer -->
      <footer class="splash-footer">
        <span class="footer-left" data-footer-left-inline>Loading environment…</span>
        <span class="footer-right">Skillerious • desktop</span>
      </footer>
    </div>

    <script>
      (() => {
        const statusText = document.querySelector("[data-status-text]");
        const progressFill = document.querySelector(".progress-fill");
        const progressLabel = document.querySelector("[data-progress-label]");
        const metaPills = Array.from(document.querySelectorAll(".meta-pill"));
        const taskListEl = document.querySelector("[data-task-list]");
        const phasePill = document.querySelector("[data-phase-pill]");
        const footerLeftInline = document.querySelector("[data-footer-left-inline]");
        const footerLeftChip = document.querySelector("[data-footer-left]");
        const envLine = document.querySelector("[data-env-line]");

        const DEFAULT_CONFIG = {
          envText: "Environment: Desktop • GitHub enabled",
          footerText: "Loading environment…",
          phase: "Loading",
          steps: [
            {
              id: "ui",
              label: "Loading interface",
              subLabel: "Panels, theme, routes",
              statusText: "Loading interface…",
              progress: 0.25,
              durationMs: 1200,
              pillIndex: 0
            },
            {
              id: "workspace",
              label: "Restoring workspace",
              subLabel: "Session, file context",
              statusText: "Restoring last session…",
              progress: 0.5,
              durationMs: 1200,
              pillIndex: 1
            },
            {
              id: "github",
              label: "Syncing with GitHub",
              subLabel: "Remote manifests",
              statusText: "Contacting remote…",
              progress: 0.78,
              durationMs: 1200,
              pillIndex: 2
            },
            {
              id: "final",
              label: "Finalising",
              subLabel: "Applying preferences",
              statusText: "Finalising environment…",
              progress: 0.92,
              durationMs: 1000,
              pillIndex: 2
            }
          ]
        };

        let currentConfig = structuredClone(DEFAULT_CONFIG);
        let currentStepIndex = 0;
        let progressAnimFrame = null;
        let isExternalControl = false;

        function clamp01(n) {
          return Math.min(1, Math.max(0, n));
        }

        function animateProgressTo(target, duration = 350) {
          const start = performance.now();
          const startWidth = parseFloat(progressFill.style.width || "0") / 100 || 0;
          const endWidth = clamp01(target);

          if (progressAnimFrame) cancelAnimationFrame(progressAnimFrame);

          function frame(now) {
            const t = Math.min(1, (now - start) / duration);
            const eased = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            const value = startWidth + (endWidth - startWidth) * eased;
            progressFill.style.width = (value * 100).toFixed(0) + "%";
            progressLabel.textContent = (value * 100).toFixed(0) + "%";
            if (t < 1) {
              progressAnimFrame = requestAnimationFrame(frame);
            }
          }

          progressAnimFrame = requestAnimationFrame(frame);
        }

        function renderTaskList(steps) {
          if (!taskListEl) return;
          taskListEl.innerHTML = "";
          steps.forEach((step, index) => {
            const li = document.createElement("li");
            li.className = "task-item" + (index === 0 ? " active" : "");
            li.dataset.stepId = step.id;
            li.innerHTML = `
              <div class="task-bullet" aria-hidden="true"></div>
              <div class="task-text">
                <span class="task-title">${step.label}</span>
                <span class="task-sub">${step.subLabel || ""}</span>
              </div>
            `;
            taskListEl.appendChild(li);
          });
        }

        function setActiveStep(idx) {
          currentStepIndex = idx;
          const step = currentConfig.steps[idx];
          if (!step) return;

          statusText.textContent = step.statusText;
          if (phasePill && currentConfig.phase) {
            phasePill.textContent = currentConfig.phase;
          }

          animateProgressTo(step.progress, 420);

          metaPills.forEach((pill, pillIndex) => {
            pill.classList.toggle("active", pillIndex === step.pillIndex);
          });

          const allTasks = Array.from(document.querySelectorAll(".task-item"));
          allTasks.forEach((el, elIndex) => {
            el.classList.toggle("active", elIndex === idx);
          });
        }

        function runAutoSequence() {
          if (isExternalControl) return;

          const step = currentConfig.steps[currentStepIndex];
          if (!step) return;

          setActiveStep(currentStepIndex);

          setTimeout(() => {
            const nextIndex = currentStepIndex + 1;
            if (nextIndex < currentConfig.steps.length) {
              currentStepIndex = nextIndex;
              runAutoSequence();
            } else {
              animateProgressTo(1, 380);
              statusText.textContent = "Done";
              if (footerLeftInline) footerLeftInline.textContent = "Ready.";
              if (footerLeftChip) footerLeftChip.textContent = "Ready.";
            }
          }, step.durationMs || 1200);
        }

        // external control API
        window.splash = {
          setStatus(text, progress, stepIndex = null) {
            isExternalControl = true;
            if (typeof text === "string") {
              statusText.textContent = text;
            }
            if (typeof progress === "number") {
              animateProgressTo(progress, 300);
            }
            if (typeof stepIndex === "number") {
              const allTasks = Array.from(document.querySelectorAll(".task-item"));
              allTasks.forEach((el, idx) => {
                el.classList.toggle("active", idx === stepIndex);
              });
            }
          },
          finish(message = "Ready.") {
            isExternalControl = true;
            animateProgressTo(1, 280);
            statusText.textContent = "Done";
            if (footerLeftInline) footerLeftInline.textContent = message;
            if (footerLeftChip) footerLeftChip.textContent = message;
          },
          getConfig() {
            return currentConfig;
          }
        };

        // splash.config.json (optional)
        fetch("./splash.config.json", { cache: "no-store" })
          .then((res) => (res.ok ? res.json() : null))
          .then((json) => {
            if (json && typeof json === "object") {
              currentConfig = {
                ...currentConfig,
                ...json,
                steps: Array.isArray(json.steps) && json.steps.length ? json.steps : currentConfig.steps
              };
            }
          })
          .catch(() => {})
          .finally(() => {
            if (envLine && currentConfig.envText) {
              envLine.textContent = currentConfig.envText;
            }
            if (footerLeftInline && currentConfig.footerText) {
              footerLeftInline.textContent = currentConfig.footerText;
            }
            if (footerLeftChip && currentConfig.footerText) {
              footerLeftChip.textContent = currentConfig.footerText;
            }
            renderTaskList(currentConfig.steps);
            runAutoSequence();
          });
      })();
    </script>
  </body>
</html>
