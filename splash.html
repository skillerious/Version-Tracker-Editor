<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <title>Version Tracker — Loading</title>
    <link rel="stylesheet" href="./splash.css" />
  </head>
  <body>
    <div
      class="splash-window"
      role="application"
      aria-label="Version Tracker loading screen"
    >
      <!-- Titlebar -->
      <header class="splash-titlebar">
        <div class="title-left">
          <div class="title-icon" aria-hidden="true">
            <img src="./assets/logo.png" alt="" />
          </div>
          <div class="title-text">
            <span class="app-name">Version Tracker Editor</span>
            <span class="app-status" data-status-text>Starting…</span>
          </div>
        </div>
        <div class="title-right">
          <span class="title-pill" data-phase-pill>Loading</span>
        </div>
      </header>

      <!-- Body -->
      <main class="splash-body">
        <header class="primary-header">
          <h1>Preparing your workspace</h1>
          <p>Restoring layout, loading manifests, and checking for remote changes.</p>
          <span class="env-line" data-env-line>Environment: Desktop • GitHub enabled</span>
        </header>

        <div class="splash-grid">
          <div class="startup-layout" aria-label="Startup tasks">
            <div class="startup-header">
              <div>
                <h2>Startup tasks</h2>
                <p>This will only take a moment.</p>
              </div>
              <span class="progress-value" data-progress-label>0%</span>
            </div>

            <div class="progress-track" aria-hidden="true">
              <div class="progress-fill"></div>
            </div>

            <!-- vertical pills -->
            <div class="meta-column">
              <div class="meta-pill active">
                <span class="meta-title">Secure token storage</span>
                <span class="meta-sub">Encrypted locally</span>
              </div>
              <div class="meta-pill">
                <span class="meta-title">Manifest insights</span>
                <span class="meta-sub">Schema aware</span>
              </div>
              <div class="meta-pill">
                <span class="meta-title">GitHub powered</span>
                <span class="meta-sub">Remote sync</span>
              </div>
            </div>

            <!-- fills the space at the bottom -->
            <div class="activity-panel" aria-label="Current operations">
              <p class="activity-title">Currently running</p>
              <ul class="activity-list">
                <li>
                  <span class="activity-dot"></span>
                  Loading interface components…
                </li>
                <li>
                  <span class="activity-dot"></span>
                  Preparing workspace state…
                </li>
                <li data-activity-dynamic>Awaiting core services…</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- bottom pills just above footer -->
        <div class="bottom-pills" aria-label="System status">
          <div class="system-chip" data-system-primary>
            <span class="system-dot online"></span>
            Core services online
          </div>
          <div class="system-chip muted" data-system-secondary>Loading environment…</div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="splash-footer">
        <span class="footer-left" data-footer-left-inline>Loading environment…</span>
        <span class="footer-right">Skillerious • desktop</span>
      </footer>
    </div>

    <script>
      (() => {
        const statusText = document.querySelector("[data-status-text]");
        const progressFill = document.querySelector(".progress-fill");
        const progressLabel = document.querySelector("[data-progress-label]");
        const metaPills = Array.from(document.querySelectorAll(".meta-pill"));
        const phasePill = document.querySelector("[data-phase-pill]");
        const envLine = document.querySelector("[data-env-line]");
        const footerLeftInline = document.querySelector("[data-footer-left-inline]");
        const systemPrimary = document.querySelector("[data-system-primary]");
        const systemSecondary = document.querySelector("[data-system-secondary]");
        const activityDynamic = document.querySelector("[data-activity-dynamic]");

        const DEFAULT_CONFIG = {
          envText: "Environment: Desktop • GitHub enabled",
          footerText: "Loading environment…",
          phase: "Loading",
          steps: [
            {
              id: "ui",
              label: "Loading interface",
              subLabel: "Panels, theme, routes",
              statusText: "Loading interface…",
              progress: 0.25,
              durationMs: 1200,
              pillIndex: 0
            },
            {
              id: "workspace",
              label: "Restoring workspace",
              subLabel: "Session, file context",
              statusText: "Restoring last session…",
              progress: 0.5,
              durationMs: 1200,
              pillIndex: 1
            },
            {
              id: "github",
              label: "Syncing with GitHub",
              subLabel: "Remote manifests",
              statusText: "Contacting remote…",
              progress: 0.78,
              durationMs: 1200,
              pillIndex: 2
            },
            {
              id: "final",
              label: "Finalising",
              subLabel: "Applying preferences",
              statusText: "Finalising environment…",
              progress: 0.92,
              durationMs: 1000,
              pillIndex: 2
            }
          ]
        };

        let currentConfig = structuredClone(DEFAULT_CONFIG);
        let currentStepIndex = 0;
        let progressAnimFrame = null;
        let isExternalControl = false;

        function clamp01(n) {
          return Math.min(1, Math.max(0, n));
        }

        function animateProgressTo(target, duration = 350) {
          const start = performance.now();
          const startWidth = parseFloat(progressFill.style.width || "0") / 100 || 0;
          const endWidth = clamp01(target);

          if (progressAnimFrame) cancelAnimationFrame(progressAnimFrame);

          function frame(now) {
            const t = Math.min(1, (now - start) / duration);
            const eased = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            const value = startWidth + (endWidth - startWidth) * eased;
            progressFill.style.width = (value * 100).toFixed(0) + "%";
            progressLabel.textContent = (value * 100).toFixed(0) + "%";
            if (t < 1) {
              progressAnimFrame = requestAnimationFrame(frame);
            }
          }

          progressAnimFrame = requestAnimationFrame(frame);
        }

        function setActiveStep(idx) {
          currentStepIndex = idx;
          const step = currentConfig.steps[idx];
          if (!step) return;

          // status line under title
          statusText.textContent = step.statusText;

          // main phase pill
          if (phasePill && currentConfig.phase) {
            phasePill.textContent = currentConfig.phase;
          }

          // progress
          animateProgressTo(step.progress, 420);

          // highlight correct pill (clamped to available ones)
          metaPills.forEach((pill, pillIndex) => {
            const active =
              typeof step.pillIndex === "number"
                ? step.pillIndex === pillIndex
                : pillIndex === idx;
            pill.classList.toggle("active", active);
          });

          // reflect in activity panel
          if (activityDynamic) {
            activityDynamic.textContent = step.statusText || step.label || "Working…";
          }
        }

        function runAutoSequence() {
          if (isExternalControl) return;
          const step = currentConfig.steps[currentStepIndex];
          if (!step) return;

          setActiveStep(currentStepIndex);

          setTimeout(() => {
            const nextIndex = currentStepIndex + 1;
            if (nextIndex < currentConfig.steps.length) {
              currentStepIndex = nextIndex;
              runAutoSequence();
            } else {
              // finished
              animateProgressTo(1, 380);
              statusText.textContent = "Done";
              if (footerLeftInline) footerLeftInline.textContent = "Ready.";
              if (systemSecondary) systemSecondary.textContent = "Ready.";
              if (activityDynamic) activityDynamic.textContent = "Environment initialised.";
            }
          }, step.durationMs || 1200);
        }

        // external control API
        window.splash = {
          setStatus(text, progress) {
            isExternalControl = true;
            if (typeof text === "string") {
              statusText.textContent = text;
              if (activityDynamic) activityDynamic.textContent = text;
            }
            if (typeof progress === "number") {
              animateProgressTo(progress, 300);
            }
          },
          finish(message = "Ready.") {
            isExternalControl = true;
            animateProgressTo(1, 280);
            statusText.textContent = "Done";
            if (footerLeftInline) footerLeftInline.textContent = message;
            if (systemSecondary) systemSecondary.textContent = message;
            if (activityDynamic) activityDynamic.textContent = message;
          },
          getConfig() {
            return currentConfig;
          }
        };

        // load optional JSON override
        fetch("./splash.config.json", { cache: "no-store" })
          .then((res) => (res.ok ? res.json() : null))
          .then((json) => {
            if (json && typeof json === "object") {
              currentConfig = {
                ...currentConfig,
                ...json,
                steps:
                  Array.isArray(json.steps) && json.steps.length
                    ? json.steps
                    : currentConfig.steps
              };
            }
          })
          .catch(() => {})
          .finally(() => {
            // apply env/footer from config
            if (envLine && currentConfig.envText) {
              envLine.textContent = currentConfig.envText;
            }
            if (footerLeftInline && currentConfig.footerText) {
              footerLeftInline.textContent = currentConfig.footerText;
            }
            if (systemSecondary && currentConfig.footerText) {
              systemSecondary.textContent = currentConfig.footerText;
            }
            runAutoSequence();
          });

        // accessibility
        if (systemPrimary) {
          systemPrimary.setAttribute("aria-live", "polite");
        }
      })();
    </script>
  </body>
</html>
